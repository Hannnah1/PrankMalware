#!/bin/bash
remove () {
  userid=$(id -u);
  launchctl bootout gui/$userid com.sshd.plist
  rm $HOME/Library/LaunchAgents/com.sshd.plist
  echo "removed"
}

while [[ $# -gt 0 ]]; do
  key="$1"
  case $key in
    -r|--remove)
      REMOVE=1
      shift
      ;;
  esac
done

if [[ $REMOVE -eq 1 ]]; then
  remove
  exit 0
fi


# install requirements for the python program. May not be necessary
#pip3 install -r requirements.txt

userid=$(id -u);
mkdir -p $HOME/.sshlocal
pushd $HOME/.sshlocal

if [[ "$OSTYPE" == "linux-gnu"* ]]; then
  mkdir -p $HOME/.config/autostart

  echo '[Desktop Entry]
  Type=Application
  Name="gotcha"
  Exec='$HOME'/.sshlocal/window_sync.sh
  X-GNOME-Autostart-enabled=true' > $HOME/.config/autostart/a.desktop

  chmod +x $HOME/.sshlocal/window_sync.sh

  pip3 install playsound
  popd
  exit 0
fi
#
# plist files are special xml files that the os uses to launch startup processes.
# we are generating the file here so we can use the $USER environment variable.
#
echo '<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
    <key>Label</key>
    <string>com.sshd.plist</string>
    <key>ProgramArguments</key>
    <array>
        <string>bash</string>
        <string>'$HOME'/.sshlocal/window_sync.sh</string>
    </array>
    <key>WorkingDirectory</key>
    <string>'$HOME'/.sshlocal</string>
    <key>RunAtLoad</key>
    <true/>
    <key>StandardErrorPath</key>
    <string>err.log</string>
</dict>
</plist>' > ./com.sshd.plist
#
# Copying the file into this directory allows the script to run on login
#
cp ./com.sshd.plist $HOME/Library/LaunchAgents/com.sshd.plist
#
# According to some sources, chaning the permissions is necessary however it seems like not.
#
#chmod 400 /Users/$USER/Library/LaunchAgents/com.sshd.plist
#chmod 400 /Users/$USER/.sshd/com.sshd.plist
#
launchctl bootstrap gui/$userid com.sshd.plist
